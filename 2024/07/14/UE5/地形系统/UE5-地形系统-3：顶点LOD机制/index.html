<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Hexo">
  <link 
    rel="icon" 
    href="/img/logo.jpg">
  <title>UE5-地形系统-3：顶点LOD机制</title>
  
    
      <meta 
        property="og:title" 
        content="UE5-地形系统-3：顶点LOD机制">
    
    
      <meta 
        property="og:url" 
        content="https://suikasan111.github.io/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/index.html">
    
    
      <meta 
        property="og:img" 
        content="/img/logo.jpg">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2024-07-14">
      <meta 
        property="og:article:modified_time" 
        content="2024-08-19">
      <meta 
        property="og:article:author" 
        content="Yi &#34;suikasan&#34; Xu">
      
        
          <meta 
            property="og:article:tag" 
            content="地形系统">
        
          <meta 
            property="og:article:tag" 
            content="UE5">
        
          <meta 
            property="og:article:tag" 
            content="UE5地形">
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
      
      
      
      
        
        
        
        <script>
          function prismThemeChange() {
            if(document.getElementById('theme-color').dataset.mode === 'dark') {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            } else {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            }
          }
          prismThemeChange()
        </script>
      
      
        
        <link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">
      
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
        prismThemeChange();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
    
    <link rel="prefetch" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" as="script">
  
  
  
  <link rel="stylesheet" href="/js/prism/prism.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css"> 
<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="/img/logo.jpg" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">SUIKASAN</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          Home
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          Archive
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          Tags
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          Categories
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          About
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          Friends
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="/img/logo.jpg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">Yi "suikasan" Xu</p>
<p class="author-description">Done is better than perfect</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>43</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>9</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>14</span>
    <span>Tags</span>
  </a>
</div>

  <div class="author-card-society">
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://github.com/SUIKASAN111">
          <i class="iconfont icon-github society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://space.bilibili.com/175051927?spm_id_from=333.1007.0.0">
          <i class="iconfont icon-bilibili society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://steamcommunity.com/id/liloneeeee/">
          <i class="iconfont icon-steam society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a href="mailto:xone111@126.com">
          <i class="iconfont icon-mail society-icon"></i>
        </a>
      </div>
    
  </div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod-distribution"><span class="toc-text"> LOD Distribution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 游戏线程中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 渲染线程中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vertexfactory"><span class="toc-text"> VertexFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lod%E9%A1%B6%E7%82%B9%E6%95%B0%E8%AE%A1%E7%AE%97%E7%A4%BA%E4%BE%8B"><span class="toc-text"> LOD顶点数计算示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uniform-parameters"><span class="toc-text"> Uniform Parameters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uniform-shader-parameters"><span class="toc-text"> Uniform Shader Parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lod-uniform-parameters"><span class="toc-text"> LOD Uniform Parameters</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod%E6%9B%B4%E6%96%B0"><span class="toc-text"> LOD更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#continuous-lod%E6%9C%BA%E5%88%B6"><span class="toc-text"> Continuous LOD机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
      <a href="/categories/CPP/">
        <div class="categories-list-item">
          CPP
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/GDC/">
        <div class="categories-list-item">
          GDC
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/Design-Pattern/">
        <div class="categories-list-item">
          Design-Pattern
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/GAMES202/">
        <div class="categories-list-item">
          GAMES202
          <span class="categories-list-item-badge">5</span>
        </div>
      </a>
    
      <a href="/categories/Tools/">
        <div class="categories-list-item">
          Tools
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/GAMES101/">
        <div class="categories-list-item">
          GAMES101
          <span class="categories-list-item-badge">18</span>
        </div>
      </a>
    
      <a href="/categories/UE5%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/">
        <div class="categories-list-item">
          UE5地形系统
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/UE5%E6%BA%90%E7%A0%81%E4%BF%AE%E6%94%B9%E5%AE%9E%E6%88%98/">
        <div class="categories-list-item">
          UE5源码修改实战
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/UE5%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/">
        <div class="categories-list-item">
          UE5渲染架构
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/UE5/" 
        title="UE5">
        <div class="tags-list-item">UE5</div>
      </a>
    
      <a 
        href="/tags/GAMES101%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/" 
        title="GAMES101知识梳理">
        <div class="tags-list-item">GAMES101知识梳理</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/" 
        title="UE5渲染架构">
        <div class="tags-list-item">UE5渲染架构</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" 
        title="UE5源码解析">
        <div class="tags-list-item">UE5源码解析</div>
      </a>
    
      <a 
        href="/tags/GAMES101%E4%BD%9C%E4%B8%9A/" 
        title="GAMES101作业">
        <div class="tags-list-item">GAMES101作业</div>
      </a>
    
      <a 
        href="/tags/GAMES202%E7%AC%94%E8%AE%B0/" 
        title="GAMES202笔记">
        <div class="tags-list-item">GAMES202笔记</div>
      </a>
    
      <a 
        href="/tags/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/" 
        title="地形系统">
        <div class="tags-list-item">地形系统</div>
      </a>
    
      <a 
        href="/tags/UE5%E5%A4%9A%E7%BA%BF%E7%A8%8B/" 
        title="UE5多线程">
        <div class="tags-list-item">UE5多线程</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%BA%90%E7%A0%81%E5%AE%9E%E6%88%98/" 
        title="UE5源码实战">
        <div class="tags-list-item">UE5源码实战</div>
      </a>
    
      <a 
        href="/tags/UE5%E5%9C%B0%E5%BD%A2/" 
        title="UE5地形">
        <div class="tags-list-item">UE5地形</div>
      </a>
    
      <a 
        href="/tags/Markdown/" 
        title="Markdown">
        <div class="tags-list-item">Markdown</div>
      </a>
    
      <a 
        href="/tags/Head-First-Design-Patterns/" 
        title="Head First Design Patterns">
        <div class="tags-list-item">Head First Design Patterns</div>
      </a>
    
      <a 
        href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/" 
        title="游戏引擎">
        <div class="tags-list-item">游戏引擎</div>
      </a>
    
      <a 
        href="/tags/CPP/" 
        title="CPP">
        <div class="tags-list-item">CPP</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
<article class="card card-content">
  <header>
    <h1 class="post-title">
      UE5-地形系统-3：顶点LOD机制
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2024-07-14T13:25:39.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2024-07-14</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/UE5%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/" 
          class="post-meta-link">
          UE5地形系统
        </a>
      
    
    
      <span class="dot"></span>
      <span>3.5k words</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/" 
            class="post-meta-link">
            地形系统
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/UE5/" 
            class="post-meta-link">
            UE5
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/UE5%E5%9C%B0%E5%BD%A2/" 
            class="post-meta-link">
            UE5地形
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <h2 id="说明"><a class="markdownIt-Anchor" href="#说明"></a> 说明</h2>
<p>本文为<a href="https://suikasan111.github.io/categories/UE5%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/">UE5-地形系统系列</a>的第三篇文章，主要是对UE5地形系统中顶点的LOD机制以及Continuous LOD算法进行分析</p>
<h2 id="lod-distribution"><a class="markdownIt-Anchor" href="#lod-distribution"></a> LOD Distribution</h2>
<h3 id="游戏线程中"><a class="markdownIt-Anchor" href="#游戏线程中"></a> 游戏线程中</h3>
<p>地形的 LOD 由以下变量影响：</p>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/LODDistribution.png" alt="LODDistribution" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/LODDistribution.png" class="lozad post-image"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Classes\LandscapeProxy.h

UCLASS(Abstract, MinimalAPI, NotBlueprintable, NotPlaceable, hidecategories&#x3D;(Display, Attachment, Physics, Debug, Lighting), showcategories&#x3D;(Lighting, Rendering, Transformation), hidecategories&#x3D;(Mobility))
class ALandscapeProxy : public APartitionActor, public ILandscapeSplineInterface
&#123;
    GENERATED_BODY()

public:
    (...)

    &#x2F;** This is the starting screen size used to calculate the distribution. You can increase the value if you want less LOD0 component, and you use very large landscape component. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;!bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;LOD 0 Screen Size&quot;, ClampMin &#x3D; &quot;0.1&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;0.1&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    float LOD0ScreenSize &#x3D; 0.5f;

    &#x2F;** The distribution setting used to change the LOD 0 generation, 1.25 is the normal distribution, numbers influence directly the LOD0 proportion on screen. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;!bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;LOD 0&quot;, ClampMin &#x3D; &quot;1.0&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;1.0&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    float LOD0DistributionSetting &#x3D; 1.25f;

    &#x2F;** The distribution setting used to change the LOD generation, 3 is the normal distribution, small number mean you want your last LODs to take more screen space and big number mean you want your first LODs to take more screen space. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;!bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;Other LODs&quot;, ClampMin &#x3D; &quot;1.0&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;1.0&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    float LODDistributionSetting &#x3D; 3.0f;

    &#x2F;** Scalable (per-quality) version of &#39;LOD 0 Screen Size&#39;. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;Scalable LOD 0 Screen Size&quot;, ClampMin &#x3D; &quot;0.1&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;0.1&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    FPerQualityLevelFloat ScalableLOD0ScreenSize &#x3D; 0.5f;

    &#x2F;** Scalable (per-quality) version of &#39;LOD 0&#39;. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;Scalable LOD 0&quot;, ClampMin &#x3D; &quot;1.0&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;1.0&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    FPerQualityLevelFloat ScalableLOD0DistributionSetting &#x3D; 1.25f;

    &#x2F;** Scalable (per-quality) version of &#39;Other LODs&#39;. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (EditCondition &#x3D; &quot;bUseScalableLODSettings&quot;, DisplayName &#x3D; &quot;Scalable Other LODs&quot;, ClampMin &#x3D; &quot;1.0&quot;, ClampMax &#x3D; &quot;10.0&quot;, UIMin &#x3D; &quot;1.0&quot;, UIMax &#x3D; &quot;10.0&quot;, LandscapeInherited))
    FPerQualityLevelFloat ScalableLODDistributionSetting &#x3D; 3.0f;

    &#x2F;** Allows to specify LOD distribution settings per quality level. Using this will ignore the r.LandscapeLOD0DistributionScale CVar. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (LandscapeInherited))
    bool bUseScalableLODSettings &#x3D; false;

    &#x2F;** This controls the area that blends LOD between neighboring sections. At 1.0 it blends across the entire section, and lower numbers reduce the blend region to be closer to the boundary. *&#x2F;
    UPROPERTY(EditAnywhere, Category &#x3D; &quot;LOD Distribution&quot;, meta &#x3D; (DisplayName &#x3D; &quot;Blend Range&quot;, ClampMin &#x3D; &quot;0.01&quot;, ClampMax &#x3D; &quot;1.0&quot;, UIMin &#x3D; &quot;0.01&quot;, UIMax &#x3D; &quot;1.0&quot;, LandscapeInherited))
    float LODBlendRange &#x3D; 1.0f;
    (...)
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="渲染线程中"><a class="markdownIt-Anchor" href="#渲染线程中"></a> 渲染线程中</h3>
<p>在构造 FLandscapeComponentSceneProxy 时，根据以上 LOD 参数计算得到 LODSettings 中的成员</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp

FLandscapeComponentSceneProxy::FLandscapeComponentSceneProxy(ULandscapeComponent* InComponent)
    : (...)
&#123;
    (...)

    const ALandscapeProxy* Proxy &#x3D; InComponent-&gt;GetLandscapeProxy();

    float LOD0ScreenSize;
    float LOD0Distribution;
    float LODDistribution;
    VirtualShadowMapConstantDepthBias &#x3D; Proxy-&gt;NonNaniteVirtualShadowMapConstantDepthBias;
    VirtualShadowMapInvalidationHeightErrorThreshold &#x3D; Proxy-&gt;NonNaniteVirtualShadowMapInvalidationHeightErrorThreshold;
    float NonNaniteVirtualShadowMapInvalidationScreenSizeLimit &#x3D; Proxy-&gt;NonNaniteVirtualShadowMapInvalidationScreenSizeLimit;

    if (Proxy-&gt;bUseScalableLODSettings)
    &#123;
        const int32 LandscapeQuality &#x3D; Scalability::GetQualityLevels().LandscapeQuality;
        
        LOD0ScreenSize &#x3D; Proxy-&gt;ScalableLOD0ScreenSize.GetValue(LandscapeQuality);
        LOD0Distribution &#x3D; Proxy-&gt;ScalableLOD0DistributionSetting.GetValue(LandscapeQuality);
        LODDistribution &#x3D; Proxy-&gt;ScalableLODDistributionSetting.GetValue(LandscapeQuality);
    &#125;
    else
    &#123;
        LOD0ScreenSize &#x3D; Proxy-&gt;LOD0ScreenSize;
        LOD0Distribution &#x3D; Proxy-&gt;LOD0DistributionSetting * GLandscapeLOD0DistributionScale;
        LODDistribution &#x3D; Proxy-&gt;LODDistributionSetting * GLandscapeLODDistributionScale;
    &#125;

    (...)

    &#x2F;&#x2F; Precompute screen ratios for each LOD level : 
    &#123;
        float ScreenSizeRatioDivider &#x3D; FMath::Max(LOD0Distribution, 1.01f);
        &#x2F;&#x2F; Cancel out so that landscape is not affected by r.StaticMeshLODDistanceScale
        float CurrentScreenSizeRatio &#x3D; LOD0ScreenSize &#x2F; CVarStaticMeshLODDistanceScale.GetValueOnAnyThread();

        LODScreenRatioSquared.AddUninitialized(MaxLOD + 1);

        &#x2F;&#x2F; LOD 0 handling
        LODScreenRatioSquared[0] &#x3D; FMath::Square(CurrentScreenSizeRatio);
        LODSettings.LOD0ScreenSizeSquared &#x3D; FMath::Square(CurrentScreenSizeRatio);
        CurrentScreenSizeRatio &#x2F;&#x3D; ScreenSizeRatioDivider;
        LODSettings.LOD1ScreenSizeSquared &#x3D; FMath::Square(CurrentScreenSizeRatio);
        ScreenSizeRatioDivider &#x3D; FMath::Max(LODDistribution, 1.01f);
        LODSettings.LODOnePlusDistributionScalarSquared &#x3D; FMath::Square(ScreenSizeRatioDivider);

        &#x2F;&#x2F; Other LODs
        for (int32 LODIndex &#x3D; 1; LODIndex &lt;&#x3D; MaxLOD; ++LODIndex) &#x2F;&#x2F; This should ALWAYS be calculated from the component size, not user MaxLOD override
        &#123;
            LODScreenRatioSquared[LODIndex] &#x3D; FMath::Square(CurrentScreenSizeRatio);
            CurrentScreenSizeRatio &#x2F;&#x3D; ScreenSizeRatioDivider;
        &#125;
    &#125;

    FirstLOD &#x3D; 0;
    LastLOD &#x3D; MaxLOD;   &#x2F;&#x2F; we always need to go to MaxLOD regardless of LODBias as we could need the lowest LODs due to streaming.

    &#x2F;&#x2F; Make sure out LastLOD is &gt; of MinStreamedLOD otherwise we would not be using the right LOD-&gt;MIP, the only drawback is a possible minor memory usage for overallocating static mesh element batch
    const int32 MinStreamedLOD &#x3D; HeightmapTexture ? FMath::Min&lt;int32&gt;(HeightmapTexture-&gt;GetNumMips() - HeightmapTexture-&gt;GetNumResidentMips(), FMath::CeilLogTwo(SubsectionSizeVerts) - 1) : 0;
    LastLOD &#x3D; FMath::Max(MinStreamedLOD, LastLOD);

    &#x2F;&#x2F; Clamp to MaxLODLevel
    const int32 MaxLODLevel &#x3D; InComponent-&gt;GetLandscapeProxy()-&gt;MaxLODLevel;
    if (MaxLODLevel &gt;&#x3D; 0)
    &#123;
        MaxLOD &#x3D; FMath::Min&lt;int8&gt;(static_cast&lt;int8&gt;(MaxLODLevel), MaxLOD);
        LastLOD &#x3D; FMath::Min&lt;int32&gt;(MaxLODLevel, LastLOD);
    &#125;

    &#x2F;&#x2F; Clamp ForcedLOD to the valid range and then apply
    int8 ForcedLOD &#x3D; static_cast&lt;int8&gt;(InComponent-&gt;ForcedLOD);
    ForcedLOD &#x3D; static_cast&lt;int8&gt;(ForcedLOD &gt;&#x3D; 0 ? FMath::Clamp&lt;int32&gt;(ForcedLOD, FirstLOD, LastLOD) : ForcedLOD);
    FirstLOD &#x3D; ForcedLOD &gt;&#x3D; 0 ? ForcedLOD : FirstLOD;
    LastLOD &#x3D; ForcedLOD &gt;&#x3D; 0 ? ForcedLOD : LastLOD;

    LODSettings.LastLODIndex &#x3D; static_cast&lt;int8&gt;(LastLOD);
    LODSettings.LastLODScreenSizeSquared &#x3D; LODScreenRatioSquared[LastLOD];
    LODSettings.ForcedLOD &#x3D; ForcedLOD;

    (...)
&#125;

&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Public\LandscapeRender.h

struct FLandscapeRenderSystem
&#123;
    struct LODSettingsComponent
    &#123;
        float LOD0ScreenSizeSquared;
        float LOD1ScreenSizeSquared;
        float LODOnePlusDistributionScalarSquared;
        float LastLODScreenSizeSquared;
        float VirtualShadowMapInvalidationLimitLOD;
        int8 LastLODIndex;
        int8 ForcedLOD;
        int8 DrawCollisionPawnLOD;
        int8 DrawCollisionVisibilityLOD;
    &#125;;

    (...)
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="vertexfactory"><a class="markdownIt-Anchor" href="#vertexfactory"></a> VertexFactory</h2>
<p>地形顶点工厂的定义如下</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Shaders\Private\LandscapeVertexFactory.ush

struct FVertexFactoryInput
&#123;
    &#x2F;&#x2F; UByte4
    uint4 Position : ATTRIBUTE0;

#if LANDSCAPE_TILE
    &#x2F;&#x2F; UByte4
    uint4 TileData : ATTRIBUTE1;
#else
    &#x2F;&#x2F; Dynamic instancing related attributes with InstanceIdOffset : ATTRIBUTE1
    VF_GPUSCENE_DECLARE_INPUT_BLOCK(1)
#endif
    VF_INSTANCED_STEREO_DECLARE_INPUT_BLOCK()
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Position.xy 为该顶点在所属 Section 中的局部坐标，<a target="_blank" rel="noopener" href="http://Position.zw">Position.zw</a> 为顶点所属 Section 在其 Component 中的坐标。</p>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/LandscapeComponentInfo.png" alt="LandscapeComponentInfo" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/LandscapeComponentInfo.png" class="lozad post-image"></p>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VSInput.png" alt="VSInput" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VSInput.png" class="lozad post-image"></p>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VSOutput.png" alt="VSOutput" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VSOutput.png" class="lozad post-image"></p>
<h3 id="lod顶点数计算示例"><a class="markdownIt-Anchor" href="#lod顶点数计算示例"></a> LOD顶点数计算示例</h3>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCal.png" alt="VertexCal" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCal.png" class="lozad post-image"></p>
<p>Component 的 LOD 增加 1 级，其 Section X和Y方向上的顶点数减半</p>
<p>LOD 0<br>
<img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCalVSInputLOD0.png" alt="VertexCalVSInputLOD0" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCalVSInputLOD0.png" class="lozad post-image"></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>N</mi><mi>u</mi><mi>m</mi><mo>=</mo><mo stretchy="false">(</mo><mn>64</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><mn>64</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><mn>2</mn><mo>⋅</mo><mn>2</mn><mo>⋅</mo><mn>6</mn><mo>=</mo><mn>95256</mn></mrow><annotation encoding="application/x-tex">VertexNum=(64-1)\cdot(64-1)\cdot2\cdot2\cdot6=95256</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">5</span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></p>
<p>LOD 1<br>
<img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCalVSInputLOD1.png" alt="VertexCalVSInputLOD1" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/VertexCalVSInputLOD1.png" class="lozad post-image"><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>N</mi><mi>u</mi><mi>m</mi><mo>=</mo><mo stretchy="false">(</mo><mn>32</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><mn>32</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><mn>2</mn><mo>⋅</mo><mn>2</mn><mo>⋅</mo><mn>6</mn><mo>=</mo><mn>23064</mn></mrow><annotation encoding="application/x-tex">VertexNum=(32-1)\cdot(32-1)\cdot2\cdot2\cdot6=23064</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">3</span><span class="mord">0</span><span class="mord">6</span><span class="mord">4</span></span></span></span></p>
<h2 id="uniform-parameters"><a class="markdownIt-Anchor" href="#uniform-parameters"></a> Uniform Parameters</h2>
<h3 id="uniform-shader-parameters"><a class="markdownIt-Anchor" href="#uniform-shader-parameters"></a> Uniform Shader Parameters</h3>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Public\LandscapeRender.h

&#x2F;** The uniform shader parameters for a landscape draw call. *&#x2F;
BEGIN_GLOBAL_SHADER_PARAMETER_STRUCT(FLandscapeUniformShaderParameters, LANDSCAPE_API)
    SHADER_PARAMETER(int32, ComponentBaseX)
    SHADER_PARAMETER(int32, ComponentBaseY)
    SHADER_PARAMETER(int32, SubsectionSizeVerts)
    SHADER_PARAMETER(int32, NumSubsections)
    SHADER_PARAMETER(int32, LastLOD)
    SHADER_PARAMETER(uint32, VirtualTexturePerPixelHeight)
    SHADER_PARAMETER(float, InvLODBlendRange)
    SHADER_PARAMETER(float, NonNaniteVirtualShadowMapConstantDepthBias)
    SHADER_PARAMETER(FVector4f, HeightmapTextureSize)
    SHADER_PARAMETER(FVector4f, HeightmapUVScaleBias)
    SHADER_PARAMETER(FVector4f, WeightmapUVScaleBias)
    SHADER_PARAMETER(FVector4f, LandscapeLightmapScaleBias)
    SHADER_PARAMETER(FVector4f, SubsectionSizeVertsLayerUVPan)
    SHADER_PARAMETER(FVector4f, SubsectionOffsetParams)
    SHADER_PARAMETER(FVector4f, LightmapSubsectionOffsetParams)
    SHADER_PARAMETER(FMatrix44f, LocalToWorldNoScaling)
    SHADER_PARAMETER_TEXTURE(Texture2D, HeightmapTexture)
    SHADER_PARAMETER_SAMPLER(SamplerState, HeightmapTextureSampler)
    SHADER_PARAMETER_TEXTURE(Texture2D, NormalmapTexture)
    SHADER_PARAMETER_SAMPLER(SamplerState, NormalmapTextureSampler)
    SHADER_PARAMETER_TEXTURE(Texture2D, XYOffsetmapTexture)
    SHADER_PARAMETER_SAMPLER(SamplerState, XYOffsetmapTextureSampler)
END_GLOBAL_SHADER_PARAMETER_STRUCT()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="lod-uniform-parameters"><a class="markdownIt-Anchor" href="#lod-uniform-parameters"></a> LOD Uniform Parameters</h3>
<p>LOD相关的Uniform Buffer 的声明和实现，在 Shader 中对应的 UniformBuffer 为 LandscapeContinuousLODParameters</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Public\LandscapeRender.h

BEGIN_GLOBAL_SHADER_PARAMETER_STRUCT(FLandscapeSectionLODUniformParameters, LANDSCAPE_API)
    SHADER_PARAMETER(int32, LandscapeIndex) &#x2F;&#x2F; Landscape索引
    SHADER_PARAMETER(FIntPoint, Min) &#x2F;&#x2F;
    SHADER_PARAMETER(FIntPoint, Size)
    SHADER_PARAMETER_SRV(Buffer&lt;float&gt;, SectionLODBias)
END_GLOBAL_SHADER_PARAMETER_STRUCT()

&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp
IMPLEMENT_GLOBAL_SHADER_PARAMETER_STRUCT(FLandscapeSectionLODUniformParameters, &quot;LandscapeContinuousLODParameters&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在场景中随着相机的移动，Component 的 LOD 会发生变化，因此 LOD Uniform Buffer 中的数据需要每帧更新</p>
<p>在 FSceneRenderer::OnRenderBegin 中调用 FLandscapeSceneViewExtension::PreRenderView_RenderThread，在其中创建并向渲染线程入队计算更新 LOD 的任务</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp

void FLandscapeSceneViewExtension::PreRenderView_RenderThread(FRDGBuilder&amp; GraphBuilder, FSceneView&amp; InView)
&#123;
    LandscapeViews.Emplace(InView);

    (...)

    TArray&lt;FLandscapeRenderSystem*&gt; SceneLandscapeRenderSystems &#x3D; GetLandscapeRenderSystems(InView.Family-&gt;Scene);

    &#x2F;&#x2F; Kick the job once all views have been collected.
    if (!SceneLandscapeRenderSystems.IsEmpty() &amp;&amp; LandscapeViews.Num() &#x3D;&#x3D; InView.Family-&gt;AllViews.Num())
    &#123;
        LandscapeSetupTask &#x3D; GraphBuilder.AddCommandListSetupTask([SceneRenderSystems &#x3D; MoveTemp(SceneLandscapeRenderSystems), LocalLandscapeViewsPtr &#x3D; &amp;LandscapeViews](FRHICommandListBase&amp; RHICmdList)
        &#123;
            TRACE_CPUPROFILER_EVENT_SCOPE(FLandscapeRenderSystem::ComputeLODs);
            FOptionalTaskTagScope Scope(ETaskTag::EParallelRenderingThread);
            check(!SceneRenderSystems.IsEmpty())

            for (FLandscapeRenderSystem* RenderSystem : SceneRenderSystems)
            &#123;
                RenderSystem-&gt;FetchHeightmapLODBiases();
            &#125;

            for (FLandscapeViewData&amp; LandscapeView : *LocalLandscapeViewsPtr)
            &#123;
                const uint32 ViewStateKey &#x3D; LandscapeView.View-&gt;GetViewKey() ;

                LandscapeView.LandscapeIndirection.SetNum(FLandscapeRenderSystem::LandscapeIndexAllocator.Num());

                for (FLandscapeRenderSystem* RenderSystem : SceneRenderSystems)
                &#123;
                    &#x2F;&#x2F; Store index where the LOD data for this landscape starts
                    LandscapeView.LandscapeIndirection[RenderSystem-&gt;LandscapeIndex] &#x3D; LandscapeView.LandscapeLODData.Num();

                    &#x2F;&#x2F; Compute sections lod values for this view &amp; append to the global landscape LOD data
                    const TResourceArray&lt;float&gt;&amp; CachedSectionLODValues &#x3D; RenderSystem-&gt;ComputeSectionsLODForView(*LandscapeView.View, LandscapeView.ShadowInvalidatingInstances);
                    LandscapeView.LandscapeLODData.Append(CachedSectionLODValues);
                &#125;
            &#125;

            for (FLandscapeRenderSystem* RenderSystem : SceneRenderSystems)
            &#123;
                RenderSystem-&gt;UpdateBuffers(RHICmdList);
            &#125;

            for (FLandscapeViewData&amp; LandscapeView : *LocalLandscapeViewsPtr)
            &#123;
                FRHIResourceCreateInfo CreateInfoLODBuffer(TEXT(&quot;LandscapeLODDataBuffer&quot;), &amp;LandscapeView.LandscapeLODData);
                FBufferRHIRef LandscapeLODDataBuffer &#x3D; RHICmdList.CreateVertexBuffer(LandscapeView.LandscapeLODData.GetResourceDataSize(), BUF_ShaderResource | BUF_Volatile, CreateInfoLODBuffer);
                LandscapeView.View-&gt;LandscapePerComponentDataBuffer &#x3D; RHICmdList.CreateShaderResourceView(LandscapeLODDataBuffer, sizeof(float), PF_R32_FLOAT);

                FRHIResourceCreateInfo CreateInfoIndirection(TEXT(&quot;LandscapeIndirectionBuffer&quot;), &amp;LandscapeView.LandscapeIndirection);
                FBufferRHIRef LandscapeIndirectionBuffer &#x3D; RHICmdList.CreateVertexBuffer(LandscapeView.LandscapeIndirection.GetResourceDataSize(), BUF_ShaderResource | BUF_Volatile, CreateInfoIndirection);
                LandscapeView.View-&gt;LandscapeIndirectionBuffer &#x3D; RHICmdList.CreateShaderResourceView(LandscapeIndirectionBuffer, sizeof(uint32), PF_R32_UINT);
            &#125;

        &#125;, GIsThreadedRendering &amp;&amp; GLandscapeUseAsyncTasksForLODComputation);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，LOD Uniform Buffer 在 FLandscapeRenderSystem::UpdateBuffers 中更新</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp

void FLandscapeRenderSystem::UpdateBuffers(FRHICommandListBase&amp; RHICmdList)
&#123;
    TRACE_CPUPROFILER_EVENT_SCOPE(FLandscapeRenderSystem::UpdateBuffers);

    bool bUpdateUB &#x3D; false;

    if (Size !&#x3D; FIntPoint::ZeroValue)
    &#123;
        if (!SectionLODBiasBuffer.IsValid())
        &#123;
            FRHIResourceCreateInfo CreateInfo(TEXT(&quot;SectionLODBiasBuffer&quot;), &amp;SectionLODBiases);
            const static FLazyName ClassName(TEXT(&quot;FLandscapeRenderSystem&quot;));
            CreateInfo.ClassName &#x3D; ClassName;
            SectionLODBiasBuffer &#x3D; RHICmdList.CreateVertexBuffer(SectionLODBiases.GetResourceDataSize(), BUF_ShaderResource | BUF_Dynamic, CreateInfo);
            SectionLODBiasSRV &#x3D; RHICmdList.CreateShaderResourceView(SectionLODBiasBuffer, sizeof(float), PF_R32_FLOAT);
            bUpdateUB &#x3D; true;
        &#125;
        else
        &#123;
            float* Data &#x3D; (float*)RHICmdList.LockBuffer(SectionLODBiasBuffer, 0, SectionLODBiases.GetResourceDataSize(), RLM_WriteOnly);
            FMemory::Memcpy(Data, SectionLODBiases.GetData(), SectionLODBiases.GetResourceDataSize());
            RHICmdList.UnlockBuffer(SectionLODBiasBuffer);
        &#125;

        if (bUpdateUB)
        &#123;
            FLandscapeSectionLODUniformParameters Parameters;
            Parameters.LandscapeIndex &#x3D; LandscapeIndex;
            Parameters.Min &#x3D; Min;
            Parameters.Size &#x3D; Size;
            Parameters.SectionLODBias &#x3D; SectionLODBiasSRV;

            RHICmdList.UpdateUniformBuffer(SectionLODUniformBuffer, &amp;Parameters);
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lod更新"><a class="markdownIt-Anchor" href="#lod更新"></a> LOD更新</h2>
<p>地形 LOD 的计算发生在 FLandscapeRenderSystem::ComputeSectionsLODForView，在其中对每一个 LandscapeComponentSceneProxy 调用其 ComputeLODForView 函数进行 LOD 计算</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F;Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp

const TResourceArray&lt;float&gt;&amp; FLandscapeRenderSystem::ComputeSectionsLODForView(const FSceneView&amp; InView, UE::Renderer::Private::IShadowInvalidatingInstances* InShadowInvalidatingInstances)
&#123;
    TRACE_CPUPROFILER_EVENT_SCOPE(FLandscapeRenderSystem::ComputeSectionsLODForView);

    (..)

    CachedSectionLODValues-&gt;Reset(SectionInfos.Num());
    for (FLandscapeSectionInfo* SectionInfo : SectionInfos)
    &#123;
        constexpr float DefaultLODValue &#x3D; 0.0f;
        float&amp; LODSectionValue &#x3D; CachedSectionLODValues-&gt;Add_GetRef(DefaultLODValue);
        if (SectionInfo !&#x3D; nullptr)
        &#123;
            LODSectionValue &#x3D; SectionInfo-&gt;ComputeLODForView(InView);

            (..)
        &#125;
    &#125;
    return *CachedSectionLODValues;
&#125;

float FLandscapeComponentSceneProxy::ComputeLODForView(const FSceneView&amp; InView) const
&#123;
    int32 ViewLODOverride &#x3D; GetViewLodOverride(InView, LandscapeKey);
    float ViewLODDistanceFactor &#x3D; InView.LODDistanceFactor;
    bool ViewEngineShowFlagCollisionPawn &#x3D; InView.Family-&gt;EngineShowFlags.CollisionPawn;
    bool ViewEngineShowFlagCollisionVisibility &#x3D; InView.Family-&gt;EngineShowFlags.CollisionVisibility;
    const FVector&amp; ViewOrigin &#x3D; GetLODView(InView).ViewMatrices.GetViewOrigin();
    const FMatrix&amp; ViewProjectionMatrix &#x3D; GetLODView(InView).ViewMatrices.GetProjectionMatrix();

    float LODScale &#x3D; ViewLODDistanceFactor * CVarStaticMeshLODDistanceScale.GetValueOnRenderThread();

    FLandscapeRenderSystem* LandscapeRenderSystem &#x3D; LandscapeRenderSystems.FindChecked(LandscapeKey);

    &#x2F;&#x2F; Prefer the RenderSystem&#39;s ForcedLODOverride if set over any per-component LOD override
    int32 ForcedLODLevel &#x3D; LandscapeRenderSystem-&gt;ForcedLODOverride &gt;&#x3D; 0 ? LandscapeRenderSystem-&gt;ForcedLODOverride : LODSettings.ForcedLOD;
    ForcedLODLevel &#x3D; ViewLODOverride &gt;&#x3D; 0 ? ViewLODOverride : ForcedLODLevel;
    const int32 DrawCollisionLODOverride &#x3D; GetDrawCollisionLodOverride(ViewEngineShowFlagCollisionPawn, ViewEngineShowFlagCollisionVisibility, LODSettings.DrawCollisionPawnLOD, LODSettings.DrawCollisionVisibilityLOD);
    ForcedLODLevel &#x3D; DrawCollisionLODOverride &gt;&#x3D; 0 ? DrawCollisionLODOverride : ForcedLODLevel;
    ForcedLODLevel &#x3D; FMath::Min&lt;int32&gt;(ForcedLODLevel, LODSettings.LastLODIndex);

    float LODLevel &#x3D; static_cast&lt;float&gt;(ForcedLODLevel);
    if (ForcedLODLevel &lt; 0)
    &#123;
        float SectionScreenSizeSquared &#x3D; ComputeBoundsScreenRadiusSquared(GetBounds().Origin, static_cast&lt;float&gt;(GetBounds().SphereRadius), ViewOrigin, ViewProjectionMatrix);
        SectionScreenSizeSquared &#x2F;&#x3D; FMath::Max(LODScale * LODScale, UE_SMALL_NUMBER);
        LODLevel &#x3D; FLandscapeRenderSystem::ComputeLODFromScreenSize(LODSettings, SectionScreenSizeSquared);
    &#125;

    return FMath::Max(LODLevel, 0.f);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>FLandscapeComponentSceneProxy::ComputeLODForView 中两个关键步骤：</p>
<ul>
<li>ComputeBoundsScreenRadiusSquared：根据 Component 的位置和大小，计算其 Bounding 投影至屏幕空间上的大小</li>
<li>FLandscapeRenderSystem::ComputeLODFromScreenSize：更新 Component 的 LOD 值，Uniform Buffer 中的FLandscapeSectionLODUniformParameters::SectionLOD</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Landscape\Private\LandscapeRender.cpp

float FLandscapeRenderSystem::ComputeLODFromScreenSize(const LODSettingsComponent&amp; InLODSettings, float InScreenSizeSquared)
&#123;
    &#x2F;&#x2F; Component投影至屏幕空间上的大小 &lt; LastLOD对应的屏幕空间大小
    &#x2F;&#x2F; 则返回LastLOD
    if (InScreenSizeSquared &lt;&#x3D; InLODSettings.LastLODScreenSizeSquared)
    &#123;
        return InLODSettings.LastLODIndex;
    &#125;
    &#x2F;&#x2F; Component投影至屏幕空间上的大小 &gt; LOD1对应的屏幕空间大小
    &#x2F;&#x2F; 则计算Component投影至屏幕空间上的大小，位于LOD0~LOD1之间的哪个比例处，最大是LOD0
    else if (InScreenSizeSquared &gt; InLODSettings.LOD1ScreenSizeSquared)
    &#123;
        return (InLODSettings.LOD0ScreenSizeSquared - FMath::Min(InScreenSizeSquared, InLODSettings.LOD0ScreenSizeSquared)) &#x2F; (InLODSettings.LOD0ScreenSizeSquared - InLODSettings.LOD1ScreenSizeSquared);
    &#125;
    &#x2F;&#x2F; Component投影至屏幕空间上的大小 &lt; LOD1对应的屏幕空间大小
    else
    &#123;
        &#x2F;&#x2F; No longer linear fraction, but worth the cache misses
        return 1.0f + FMath::LogX(InLODSettings.LODOnePlusDistributionScalarSquared, InLODSettings.LOD1ScreenSizeSquared &#x2F; InScreenSizeSquared);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="continuous-lod机制"><a class="markdownIt-Anchor" href="#continuous-lod机制"></a> Continuous LOD机制</h2>
<p>使用 Continuous LOD 计算顶点实际位置的主要过程是：计算顶点所属LOD层级；对于LOD整数部分，分别计算顶点在当前LOD和下一级LOD的XY坐标；采样高度图分别得到顶点在当前LOD和下一级LOD的高度；对上述坐标、高度以及顶点法线进行插值，得到最后的顶点</p>
<p><img src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/ContinuousLOD.png" alt="ContinuousLOD" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/ContinuousLOD.png" class="lozad post-image"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Shaders\Private\LandscapeVertexFactory.ush

FVertexFactoryIntermediates GetVertexFactoryIntermediates(FVertexFactoryInput Input)
&#123;
    FVertexFactoryIntermediates Intermediates;
    Intermediates.SceneData &#x3D; VF_GPUSCENE_GET_INTERMEDIATES(Input);
    &#x2F;&#x2F; Component线性索引
    Intermediates.ComponentIndex &#x3D; GetComponentLinearIndex();
    &#x2F;&#x2F; Component LOD, float4(Lod, 0, LodSubSectionSizeQuads, rcp(LodSubSectionSizeQuads))
    Intermediates.LodValues &#x3D; GetLodValues(Intermediates.ComponentIndex);
    &#x2F;&#x2F; LodBias, float2(LodBias, 0.f)
    Intermediates.LodBias &#x3D; GetLodBias(Intermediates.ComponentIndex);
    Intermediates.InputPosition &#x3D; Input.Position;

    (...)

    &#x2F;&#x2F; 顶点在Section内归一化坐标
    float2 xy &#x3D; Intermediates.InputPosition.xy * Intermediates.LodValues.w;
    &#x2F;&#x2F; 计算与最近邻混合后的LOD
    float LODCalculated &#x3D; CalcLOD(Intermediates.ComponentIndex, xy, Intermediates.InputPosition.zw);
    &#x2F;&#x2F; LOD整数部分
    float LodValue &#x3D; floor(LODCalculated);
    &#x2F;&#x2F; LOD小数部分
    float MorphAlpha &#x3D; LODCalculated - LodValue;


    &#x2F;&#x2F; 实际坐标
    &#x2F;&#x2F; 若LODCalculated向高LOD混合，则LOD整数部分与原LOD相等，实际顶点坐标（未归一化）无需变化
    &#x2F;&#x2F; 若LODCalculated向低LOD混合，则LOD整数部分比原LOD低一级，实际顶点坐标（未归一化）应变为两倍
    float2 ActualLODCoordsInt &#x3D; floor(Intermediates.InputPosition.xy * pow(2, -(LodValue - Intermediates.LodValues.x)));
    float InvLODScaleFactor &#x3D; pow(2, -LodValue);

    &#x2F;&#x2F; 坐标变换，将顶点在当前LOD下的未归一化局部坐标变换至LOD0下的归一化坐标，对NextLOD也是如此
    float2 CoordTranslate &#x3D; float2( LandscapeParameters.SubsectionSizeVertsLayerUVPan.x * InvLODScaleFactor - 1, max(LandscapeParameters.SubsectionSizeVertsLayerUVPan.x * 0.5f * InvLODScaleFactor, 2) - 1 ) * LandscapeParameters.SubsectionSizeVertsLayerUVPan.y;
    float2 InputPositionLODAdjusted &#x3D; ActualLODCoordsInt &#x2F; CoordTranslate.x;
    float2 NextLODCoordsInt &#x3D; floor(ActualLODCoordsInt * 0.5);
    float2 InputPositionNextLOD &#x3D; NextLODCoordsInt &#x2F; CoordTranslate.y;
    &#x2F;&#x2F; -------------------------------------------------------------------------------------------------
    &#x2F;&#x2F; 例：SubsectionQuads为63*63，那么在LOD0下，其顶点未归一化的局部坐标范围是[0,63]^2
    &#x2F;&#x2F;    若当前LOD为LOD1，顶点未归一化的局部坐标范围是[0,31]^2；NextLOD为LOD2，顶点未归一化的局部坐标范围是[0,15]^2
    &#x2F;&#x2F;    假设有在当前LOD下局部坐标为(0,15)的顶点，在NextLOD下局部坐标为(0,7)
    &#x2F;&#x2F;    将它们变换到LOD0下的局部坐标分别为(0,floor(15*63&#x2F;31))&#x3D;(0,30), (0, floor(7*63&#x2F;15))&#x3D;(0,29)
    &#x2F;&#x2F; -------------------------------------------------------------------------------------------------

    &#x2F;&#x2F; 对当前LOD和NextLOD分别计算HeightmapUV，并采样得到高度值（归一化到最大与最小高度之间的值），然后反算出实际高度
    &#x2F;&#x2F; Intermediates.InputPosition.zw * LandscapeParameters.SubsectionOffsetParams.xy 是subsection的原点
    float2 SampleCoords &#x3D; InputPositionLODAdjusted * LandscapeParameters.HeightmapUVScaleBias.xy + LandscapeParameters.HeightmapUVScaleBias.zw + 0.5*LandscapeParameters.HeightmapUVScaleBias.xy + Intermediates.InputPosition.zw * LandscapeParameters.SubsectionOffsetParams.xy;
    float4 SampleValue &#x3D; Texture2DSampleLevel(LandscapeParameters.HeightmapTexture, LandscapeParameters.HeightmapTextureSampler, SampleCoords, LodValue-Intermediates.LodBias.x);
    float Height &#x3D; DecodePackedHeight(SampleValue.xy);

    float2 SampleCoordsNextLOD &#x3D; InputPositionNextLOD * LandscapeParameters.HeightmapUVScaleBias.xy + LandscapeParameters.HeightmapUVScaleBias.zw + 0.5*LandscapeParameters.HeightmapUVScaleBias.xy + Intermediates.InputPosition.zw * LandscapeParameters.SubsectionOffsetParams.xy;
    float4 SampleValueNextLOD &#x3D; Texture2DSampleLevel(LandscapeParameters.HeightmapTexture, LandscapeParameters.HeightmapTextureSampler, SampleCoordsNextLOD, LodValue+1-Intermediates.LodBias.x);
    float HeightNextLOD &#x3D; DecodePackedHeight(SampleValueNextLOD.xy);

    (...)

    &#x2F;&#x2F; 顶点局部位置插值
    &#x2F;&#x2F; 根据LOD小数部分，在当前LOD和NextLOD的(未归一化局部XY坐标，高度)中插值
    Intermediates.LocalPosition &#x3D; lerp( float3(InputPositionLODAdjusted, Height), float3(InputPositionNextLOD, HeightNextLOD), MorphAlpha );
    &#x2F;&#x2F; 顶点法线插值
    float2 Normal &#x3D; float2(SampleValue.b, SampleValue.a);
    float2 NormalNextLOD &#x3D; float2(SampleValueNextLOD.b, SampleValueNextLOD.a);
    float2 InterpNormal &#x3D; lerp( Normal, NormalNextLOD, MorphAlpha ) * float2(2.0,2.0) - float2(1.0,1.0);
    Intermediates.WorldNormal &#x3D; float3( InterpNormal, sqrt(max(1.0-dot(InterpNormal,InterpNormal),0.0)) );

    return Intermediates;
&#125;


float CalcLOD(uint ComponentIndex, float2 xyLocalToSubsection, float2 Subsection)
&#123;
    (...)

    &#x2F;&#x2F; 顶点在Component内归一化坐标
    float2 xy &#x3D; (xyLocalToSubsection + Subsection) &#x2F; LandscapeParameters.NumSubsections;

    &#x2F;&#x2F; calculate blend value (normalized distance from section border: 1 at the border, 0 at the center)
    float2 Delta &#x3D; xy * 2 - 1;
    float2 AbsDelta &#x3D; abs(Delta);
    float LB &#x3D; max(AbsDelta.x, AbsDelta.y);

    &#x2F;&#x2F; AbsDelta
    &#x2F;&#x2F; (1,1)----(0,1)----(1,1)
    &#x2F;&#x2F;   |        |        |
    &#x2F;&#x2F; (1,0)----(0,0)----(1,0)
    &#x2F;&#x2F;   |        |        |
    &#x2F;&#x2F; (1,1)----(0,1)----(1,1)

    &#x2F;&#x2F; shift the blend towards 0 to reduce the lod blend range
    float k &#x3D; LandscapeParameters.InvLODBlendRange;
    LB &#x3D; saturate(1 - (1-LB) * k);

    &#x2F;&#x2F; 到最近相邻Component的Offset
    int2 NeighborOffset &#x3D; (AbsDelta.x &gt; AbsDelta.y) ? int2(sign(Delta.x), 0) : int2(0, sign(Delta.y));

    &#x2F;&#x2F; 当前Component(Center)的LOD，以及最近邻Component的LOD
    float CenterLod &#x3D; GetSectionLod(ComponentIndex);
    float NeighborLod &#x3D; GetNeighborSectionLodFromOffset(NeighborOffset, CenterLod);

    &#x2F;&#x2F; 混合LOD
    float LODCalculated &#x3D; (1-LB) * CenterLod + LB * NeighborLod;

    return LODCalculated;
#endif
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2>
<p><a target="_blank" rel="noopener" href="https://dev.epicgames.com/documentation/en-us/unreal-engine/landscape-technical-guide-in-unreal-engine">Unreal Engine Documentation: Landscape Technical Guide</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kekec/p/16907471.html">UE4地形系统（Landscape）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_29523119/article/details/125532143">UE5引擎 PC端的Landscape渲染浅分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.xianlongok.site/post/310fc368/">UE4 地形 landscape</a></p>
<p><a target="_blank" rel="noopener" href="https://zwcloud.net/#blog/109">UE4移动端地形理解 - 高度LOD</a></p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            SUIKASAN
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://suikasan111.github.io/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/">
            https://suikasan111.github.io/2024/07/14/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-3%EF%BC%9A%E9%A1%B6%E7%82%B9LOD%E6%9C%BA%E5%88%B6/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2024/07/15/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-4%EF%BC%9A%E6%80%BB%E7%BB%93/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">Prev</div>
          
            <div class="nav-title">UE5-地形系统-4：总结 </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2024/07/12/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-2%EF%BC%9A%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">UE5-地形系统-2：运行时数据转换 </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod-distribution"><span class="toc-text"> LOD Distribution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 游戏线程中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 渲染线程中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vertexfactory"><span class="toc-text"> VertexFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lod%E9%A1%B6%E7%82%B9%E6%95%B0%E8%AE%A1%E7%AE%97%E7%A4%BA%E4%BE%8B"><span class="toc-text"> LOD顶点数计算示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uniform-parameters"><span class="toc-text"> Uniform Parameters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uniform-shader-parameters"><span class="toc-text"> Uniform Shader Parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lod-uniform-parameters"><span class="toc-text"> LOD Uniform Parameters</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod%E6%9B%B4%E6%96%B0"><span class="toc-text"> LOD更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#continuous-lod%E6%9C%BA%E5%88%B6"><span class="toc-text"> Continuous LOD机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod-distribution"><span class="toc-text"> LOD Distribution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 游戏线程中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 渲染线程中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vertexfactory"><span class="toc-text"> VertexFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lod%E9%A1%B6%E7%82%B9%E6%95%B0%E8%AE%A1%E7%AE%97%E7%A4%BA%E4%BE%8B"><span class="toc-text"> LOD顶点数计算示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uniform-parameters"><span class="toc-text"> Uniform Parameters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uniform-shader-parameters"><span class="toc-text"> Uniform Shader Parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lod-uniform-parameters"><span class="toc-text"> LOD Uniform Parameters</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lod%E6%9B%B4%E6%96%B0"><span class="toc-text"> LOD更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#continuous-lod%E6%9C%BA%E5%88%B6"><span class="toc-text"> Continuous LOD机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-07-18</div>
        <a href="/2024/07/18/GDC/FrostbiteTerrainProceduralTools/"><div class="recent-posts-item-content">Frostbite Terrain Procedural Tools</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-07-17</div>
        <a href="/2024/07/17/UE5/%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/UE5-%E6%B8%B2%E6%9F%93%E7%BA%BF%E7%A8%8B%E4%B8%AD%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%BB%E5%8A%A1%E5%88%86%E5%8F%91%E7%AE%80%E6%9E%90/"><div class="recent-posts-item-content">UE5-渲染线程中多线程任务分发简析</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-07-16</div>
        <a href="/2024/07/16/UE5/%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/UE5-%E6%B8%B2%E6%9F%93%E5%B9%B6%E8%A1%8C%E5%8C%96/"><div class="recent-posts-item-content">UE5-渲染并行化</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-07-15</div>
        <a href="/2024/07/15/UE5/%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F/UE5-%E5%9C%B0%E5%BD%A2%E7%B3%BB%E7%BB%9F-4%EF%BC%9A%E6%80%BB%E7%BB%93/"><div class="recent-posts-item-content">UE5-地形系统-4：总结</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2022
          
          
                - 
                2024
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          SUIKASAN
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
      <div class="footer-dsc">
        
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
    <script src="/js/prism/prism.js" async></script>
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
      
 
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
    
      <script> 
        loadScript('/js/lib/busuanzi.min.js') 
      </script>
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
      <script>
        setTimeout(() => {localSearch("search.json")}, 0)
      </script>
    
  </body>
</html>
