<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Hexo">
  <link 
    rel="icon" 
    href="/img/logo.jpg">
  <title>UE5-添加ShadingModel</title>
  
    
      <meta 
        property="og:title" 
        content="UE5-添加ShadingModel">
    
    
      <meta 
        property="og:url" 
        content="https://suikasan111.github.io/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/index.html">
    
    
      <meta 
        property="og:img" 
        content="/2024/06/18/UE5/UE5-添加ShadingModel/banner.png">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2024-06-18">
      <meta 
        property="og:article:modified_time" 
        content="2024-08-19">
      <meta 
        property="og:article:author" 
        content="Yi &#34;suikasan&#34; Xu">
      
        
          <meta 
            property="og:article:tag" 
            content="UE5">
        
          <meta 
            property="og:article:tag" 
            content="UE5源码">
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
      
      
      
      
        
        
        
        <script>
          function prismThemeChange() {
            if(document.getElementById('theme-color').dataset.mode === 'dark') {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            } else {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            }
          }
          prismThemeChange()
        </script>
      
      
        
        <link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">
      
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
        prismThemeChange();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
    
    <link rel="prefetch" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" as="script">
  
  
  
  <link rel="stylesheet" href="/js/prism/prism.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css"> 
<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="/img/logo.jpg" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">SUIKASAN</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          Home
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          Archive
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          Tags
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          Categories
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          About
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          Friends
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="/img/logo.jpg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">Yi "suikasan" Xu</p>
<p class="author-description">Done is better than perfect</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>31</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>7</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>11</span>
    <span>Tags</span>
  </a>
</div>

  <div class="author-card-society">
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://github.com/SUIKASAN111">
          <i class="iconfont icon-github society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://space.bilibili.com/175051927?spm_id_from=333.1007.0.0">
          <i class="iconfont icon-bilibili society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://steamcommunity.com/id/liloneeeee/">
          <i class="iconfont icon-steam society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a href="mailto:xone111@126.com">
          <i class="iconfont icon-mail society-icon"></i>
        </a>
      </div>
    
  </div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ue5-%E5%86%85%E7%BD%AEshadingmodels"><span class="toc-text"> UE5 内置ShadingModels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89shading-model"><span class="toc-text"> 添加自定义Shading Model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0shading-model%E7%9A%84%E6%80%BB%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-text"> 添加Shading Model的总体步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0toonshadingmodel"><span class="toc-text"> 添加ToonShadingModel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#c%E9%83%A8%E5%88%86"><span class="toc-text"> C++部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9Eshading-model%E6%9E%9A%E4%B8%BE"><span class="toc-text"> 新增Shading Model枚举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 增加对应的关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%83%85%E5%86%B5%E5%BC%80%E5%90%AF%E6%9D%90%E8%B4%A8%E6%8E%A5%E5%8F%A3%E5%8F%AF%E9%80%89"><span class="toc-text"> 根据情况开启材质接口（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shader%E9%83%A8%E5%88%86"><span class="toc-text"> Shader部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8shader%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 在Shader中定义关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AFcustomdata%E5%86%99%E5%85%A5%E5%8F%AF%E9%80%89"><span class="toc-text"> 开启CustomData写入（可选）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%89%E6%BA%90%E6%95%B0%E6%8D%AE"><span class="toc-text"> 获取光源数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E8%AE%A1%E7%AE%97"><span class="toc-text"> 着色计算</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E6%A8%A1%E5%BC%8F%E6%94%AF%E6%8C%81%E4%BD%93%E7%A7%AF%E5%85%89%E5%8F%A0%E5%8A%A0%E5%8F%AF%E9%80%89"><span class="toc-text"> 透明模式支持体积光叠加（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text"> 效果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debug%E6%A8%A1%E5%BC%8F%E4%B8%8B"><span class="toc-text"> Debug模式下</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E6%9D%90%E8%B4%A8"><span class="toc-text"> 新建材质</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
      <a href="/categories/CPP/">
        <div class="categories-list-item">
          CPP
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/GAMES101/">
        <div class="categories-list-item">
          GAMES101
          <span class="categories-list-item-badge">18</span>
        </div>
      </a>
    
      <a href="/categories/GAMES202/">
        <div class="categories-list-item">
          GAMES202
          <span class="categories-list-item-badge">5</span>
        </div>
      </a>
    
      <a href="/categories/Tools/">
        <div class="categories-list-item">
          Tools
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/Design-Pattern/">
        <div class="categories-list-item">
          Design-Pattern
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/UE5%E6%BA%90%E7%A0%81%E4%BF%AE%E6%94%B9%E5%AE%9E%E6%88%98/">
        <div class="categories-list-item">
          UE5源码修改实战
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/UE5%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/">
        <div class="categories-list-item">
          UE5渲染架构
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/GAMES101%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/" 
        title="GAMES101知识梳理">
        <div class="tags-list-item">GAMES101知识梳理</div>
      </a>
    
      <a 
        href="/tags/GAMES101%E4%BD%9C%E4%B8%9A/" 
        title="GAMES101作业">
        <div class="tags-list-item">GAMES101作业</div>
      </a>
    
      <a 
        href="/tags/UE5/" 
        title="UE5">
        <div class="tags-list-item">UE5</div>
      </a>
    
      <a 
        href="/tags/GAMES202%E7%AC%94%E8%AE%B0/" 
        title="GAMES202笔记">
        <div class="tags-list-item">GAMES202笔记</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%BA%90%E7%A0%81/" 
        title="UE5源码">
        <div class="tags-list-item">UE5源码</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%B8%B2%E6%9F%93%E6%9E%B6%E6%9E%84/" 
        title="UE5渲染架构">
        <div class="tags-list-item">UE5渲染架构</div>
      </a>
    
      <a 
        href="/tags/UE5%E6%9D%90%E8%B4%A8/" 
        title="UE5材质">
        <div class="tags-list-item">UE5材质</div>
      </a>
    
      <a 
        href="/tags/UE5-Shader/" 
        title="UE5 Shader">
        <div class="tags-list-item">UE5 Shader</div>
      </a>
    
      <a 
        href="/tags/Head-First-Design-Patterns/" 
        title="Head First Design Patterns">
        <div class="tags-list-item">Head First Design Patterns</div>
      </a>
    
      <a 
        href="/tags/Markdown/" 
        title="Markdown">
        <div class="tags-list-item">Markdown</div>
      </a>
    
      <a 
        href="/tags/CPP/" 
        title="CPP">
        <div class="tags-list-item">CPP</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
  <div class="image-wrapper">
    <img 
      src="/2024/06/18/UE5/UE5-添加ShadingModel/banner.png" 
      data-src="/2024/06/18/UE5/UE5-添加ShadingModel/banner.png"
      srcset="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%20300%20300&#39;%3E%3C/svg%3E"
      class="image lozad"
      alt="UE5-添加ShadingModel thumbnail">
  </div>

<article class="card card-content">
  <header>
    <h1 class="post-title">
      UE5-添加ShadingModel
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2024-06-18T10:54:36.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2024-06-18</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/UE5%E6%BA%90%E7%A0%81%E4%BF%AE%E6%94%B9%E5%AE%9E%E6%88%98/" 
          class="post-meta-link">
          UE5源码修改实战
        </a>
      
    
    
      <span class="dot"></span>
      <span>3.2k words</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/UE5/" 
            class="post-meta-link">
            UE5
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/UE5%E6%BA%90%E7%A0%81/" 
            class="post-meta-link">
            UE5源码
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <h2 id="说明"><a class="markdownIt-Anchor" href="#说明"></a> 说明</h2>
<p>本文基于UE5.4.3，通过添加自定义ShadingModel实现简单的卡渲效果。</p>
<h2 id="ue5-内置shadingmodels"><a class="markdownIt-Anchor" href="#ue5-内置shadingmodels"></a> UE5 内置ShadingModels</h2>
<p>UE5内置了13种着色模型，定义在ShadingModels.ush中</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ShadingModels.ush

FDirectLighting IntegrateBxDF( FGBufferData GBuffer, half3 N, half3 V, half3 L, float Falloff, half NoL, FAreaLight AreaLight, FShadowTerms Shadow )
&#123;
    switch( GBuffer.ShadingModelID )
    &#123;
        case SHADINGMODELID_DEFAULT_LIT:
        case SHADINGMODELID_SINGLELAYERWATER:
        case SHADINGMODELID_THIN_TRANSLUCENT:
            return DefaultLitBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_SUBSURFACE:
            return SubsurfaceBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_PREINTEGRATED_SKIN:
            return PreintegratedSkinBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_CLEAR_COAT:
            return ClearCoatBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_SUBSURFACE_PROFILE:
            return SubsurfaceProfileBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_TWOSIDED_FOLIAGE:
            return TwoSidedBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_HAIR:
            return HairBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_CLOTH:
            return ClothBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        case SHADINGMODELID_EYE:
            return EyeBxDF( GBuffer, N, V, L, Falloff, NoL, AreaLight, Shadow );
        default:
            return (FDirectLighting)0;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，DefaultLitBxDF, SubsurfaceBxDF等就是对应的shading models的实现。</p>
<ul>
<li>Unlit: 无光照，只有Emissive Color；</li>
<li>Default Unlit: 默认光照，Diffuse使用Lambertian，Specular使用的DGF分别为GGX法线分布、SmithJoint遮挡、Schlick近似；</li>
<li>Subsurface: 次表面散射，添加一层额外的diffuse layer来近似表现次表面散射现象；</li>
<li>Preintegrated Skin: 预计算皮肤，是Subsurface Model在皮肤情况下的特化，参数与Subsurface model一致；</li>
<li>Clear Coat: 清漆，多层材质的一种最简单的形式，增加一层额外的specular layer来模拟材质表面的一层薄薄的透明膜；</li>
<li>Subsurface Profile: Subsurface Profile也是用于渲染皮肤的模型，是Preintegrated Skin模型的加强版，效果更真实，数字人的皮肤渲染使用的即该光照模型；</li>
<li>Two Sided Foliage: 用于渲染较薄的次表面散射材质，例如树叶、花瓣等，它可以模拟光线穿过材质的效果，比Subsurface model更真实；</li>
<li>Hair: 用于模拟毛发的渲染效果，主要依据的是Marschner Model；</li>
<li>Cloth: 布料模型和其他几个ShadingModel不一样，因为布料的组成形式是纤维的互相堆叠，纤维之间还存在空隙，不符合微表面理论，模拟Cloth的BRDF模型大致可以分为三类：
<ul>
<li>基于观察的empirical models</li>
<li>基于微表面理论的模型</li>
<li>微圆柱体模型（micro-cylinder model）</li>
</ul>
</li>
<li>Eye: 用于模拟眼睛的表面，加入了控制虹膜的参数；</li>
<li>SingleLayerWater: 用于模拟透明水面的效果，降低使用透明模式混合的开销和复杂度，与Default Lit模型公用同一套BxDF公式，但参数比Default Lit多两个(Opacity, Refraction)；</li>
<li>Thin Translucent: 用于模拟基于物理原理的半透明材质，能够更真实地还原高光和背景色，与Default Lit模型公用同一套BxDF公式，但参数比Default Lit多一个(Opacity)；</li>
<li>From Material Expression: 将多个shading model合并到单个材质中。</li>
</ul>
<h2 id="添加自定义shading-model"><a class="markdownIt-Anchor" href="#添加自定义shading-model"></a> 添加自定义Shading Model</h2>
<p>很多简单的光照都可以通过Unlit模式实现。但如果需要引擎的光影功能（比如需要阴影的情况）就需要通过增加ShadingModel实现。这对于高度风格化的游戏尤其重要。</p>
<h3 id="添加shading-model的总体步骤"><a class="markdownIt-Anchor" href="#添加shading-model的总体步骤"></a> 添加Shading Model的总体步骤</h3>
<ul>
<li>C++部分
<ol>
<li>增加一个Shading Model枚举</li>
<li>增加对应的关键字</li>
<li>根据情况开启材质接口（可选）</li>
</ol>
</li>
<li>Shader部分
<ol>
<li>在Shader中定义关键字</li>
<li>开启CustomData写入的关键字并写入（可选）</li>
<li>获取光源数据</li>
<li>开启着色模型混合（可选）</li>
<li>着色计算</li>
<li>透明模式支持体积光叠加（可选）</li>
</ol>
</li>
</ul>
<h3 id="添加toonshadingmodel"><a class="markdownIt-Anchor" href="#添加toonshadingmodel"></a> 添加ToonShadingModel</h3>
<h4 id="c部分"><a class="markdownIt-Anchor" href="#c部分"></a> C++部分</h4>
<h5 id="新增shading-model枚举"><a class="markdownIt-Anchor" href="#新增shading-model枚举"></a> 新增Shading Model枚举</h5>
<p>在EngineTypes.h中的EMaterialShadingModel添加ToonShadingModel枚举。增加这个枚举，材质编辑器Details面板中会增加对应的选项。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Classes\Engine\EngineTypes.h

&#x2F;** 
 * Specifies the overal rendering&#x2F;shading model for a material
 * @warning Check UMaterialInstance::Serialize if changed!
 *&#x2F;
UENUM()
enum EMaterialShadingModel : int
&#123;
    (...)

    &#x2F;*********** Toon Shading Model *******&#x2F;
    MSM_MyToonShadingModel      UMETA(DisplayName&#x3D;&quot;Toon&quot;),
    &#x2F;**************************************&#x2F;
   
   (...)
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="增加对应的关键字"><a class="markdownIt-Anchor" href="#增加对应的关键字"></a> 增加对应的关键字</h5>
<p>在HLSLMaterialTranslator.cpp和MaterialHLSLEmitter.cpp的GetMaterialEnvironment方法中添加宏，通过宏定义，后续在Shader中判断到底应该走什么分支，从而实现逻辑。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\Materials\HLSLMaterialTranslator.cpp

void FHLSLMaterialTranslator::GetMaterialEnvironment(EShaderPlatform InPlatform, FShaderCompilerEnvironment&amp; OutEnvironment)
&#123;
    (...)
    
    if (EnvironmentDefines-&gt;bShadingModelsIsLit)
    &#123;
        (...)
        &#x2F;********************* Toon Shading Model ********************&#x2F;
        if (EnvironmentDefines-&gt;HasShadingModel(MSM_Toon))
        &#123;
            OutEnvironment.SetDefine(TEXT(&quot;MATERIAL_SHADINGMODEL_TOON&quot;), TEXT(&quot;1&quot;));
        &#125;
        &#x2F;*************************************************************&#x2F;
        (...)
    &#125;
    
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\Materials\MaterialHLSLEmitter.cpp

static void GetMaterialEnvironment(EShaderPlatform InPlatform,
    const FMaterial&amp; InMaterial,
    const UE::HLSLTree::FEmitContext&amp; EmitContext,
    const FMaterialCompilationOutput&amp; MaterialCompilationOutput,
    bool bUsesEmissiveColor,
    bool bUsesAnisotropy,
    bool bIsFullyRough,
    FShaderCompilerEnvironment&amp; OutEnvironment)
&#123;
    (...)
   &#x2F;********************* Toon Shading Model ********************&#x2F;
    if(ShadingModels.HasShadingModel(MSM_Toon))
    &#123;
        OutEnvironment.SetDefine(TEXT(&quot;MATERIAL_SHADINGMODEL_TOON&quot;), TEXT(&quot;1&quot;));
        NumSetMaterials++;
    &#125;
   &#x2F;*************************************************************&#x2F;
    (...)   
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ShaderMaterial.h的结构体FShaderMaterialPropertyDefines中添加宏，该参数用来在C++进行材质Shader的宏操作</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\RenderCore\Public\ShaderMaterial.h

(...)
struct FShaderMaterialPropertyDefines
&#123;
    (...)
    &#x2F;****************** Toon Shading Model ***************&#x2F;
    uint8 MATERIAL_SHADINGMODEL_TOON : 1;
    &#x2F;*****************************************************&#x2F;
    (...)
&#125;;
(...)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ShaderGenerationUtil.cpp的ApplyFetchEnvironmentInternal里添加</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\ShaderCompiler\ShaderGenerationUtil.cpp

template&lt;typename EnvironmentType&gt;
void ApplyFetchEnvironmentInternal(FShaderMaterialPropertyDefines&amp; SrcDefines, const EnvironmentType&amp; Environment)
&#123;
    (...)
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_DEFAULT_LIT);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SUBSURFACE);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_CLEAR_COAT);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_HAIR);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_CLOTH);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_EYE);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_SINGLELAYERWATER);
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_THIN_TRANSLUCENT);
    &#x2F;************* Toon Shading Model ********&#x2F;
    FETCH_COMPILE_BOOL(MATERIAL_SHADINGMODEL_TOON)
    &#x2F;*****************************************&#x2F;
    (...)
&#125;

static void DetermineUsedMaterialSlots(
    EGBufferSlotUsage Slots[GBS_Num],
    const FShaderMaterialDerivedDefines&amp; Dst,
    const FShaderMaterialPropertyDefines&amp; Mat,
    const FShaderLightmapPropertyDefines&amp; Lightmap,
    const FShaderGlobalDefines&amp; SrcGlobal,
    const FShaderCompilerDefines&amp; Compiler,
    ERHIFeatureLevel::Type FEATURE_LEVEL)
    &#123;
    (...)
    &#x2F;************ Toon Shading Model ********&#x2F;
    if(Mat.MATERIAL_SHADINGMODEL_TOON)
    &#123;
        SetStandardGBufferSlots(Slots, bWriteEmissive, bHasTangent, bHasVelocity, bWritesVelocity, bHasStaticLighting, bIsSubstrateMaterial);
        Slots[GBS_CustomData] &#x3D; GetGBufferSlotUsage(bUseCustomData);
    &#125;
    &#x2F;****************************************&#x2F;
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在MaterialShader.h中的GetShadingModelString函数添加</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\Materials\MaterialShader.cpp

&#x2F;** Converts an EMaterialShadingModel to a string description. *&#x2F;
FString GetShadingModelString(EMaterialShadingModel ShadingModel)
&#123;
    FString ShadingModelName;
    switch(ShadingModel)
    &#123;
        case MSM_Unlit:             ShadingModelName &#x3D; TEXT(&quot;MSM_Unlit&quot;); break;
        case MSM_DefaultLit:        ShadingModelName &#x3D; TEXT(&quot;MSM_DefaultLit&quot;); break;
        case MSM_Subsurface:        ShadingModelName &#x3D; TEXT(&quot;MSM_Subsurface&quot;); break;
        case MSM_PreintegratedSkin: ShadingModelName &#x3D; TEXT(&quot;MSM_PreintegratedSkin&quot;); break;
        case MSM_ClearCoat:         ShadingModelName &#x3D; TEXT(&quot;MSM_ClearCoat&quot;); break;
        case MSM_SubsurfaceProfile: ShadingModelName &#x3D; TEXT(&quot;MSM_SubsurfaceProfile&quot;); break;
        case MSM_TwoSidedFoliage:   ShadingModelName &#x3D; TEXT(&quot;MSM_TwoSidedFoliage&quot;); break;
        case MSM_Hair:              ShadingModelName &#x3D; TEXT(&quot;MSM_Hair&quot;); break;
        case MSM_Cloth:             ShadingModelName &#x3D; TEXT(&quot;MSM_Cloth&quot;); break;
        case MSM_Eye:               ShadingModelName &#x3D; TEXT(&quot;MSM_Eye&quot;); break;
        case MSM_SingleLayerWater:  ShadingModelName &#x3D; TEXT(&quot;MSM_SingleLayerWater&quot;); break;
        case MSM_ThinTranslucent:   ShadingModelName &#x3D; TEXT(&quot;MSM_ThinTranslucent&quot;); break;
        case MSM_Toon:              ShadingModelName &#x3D; TEXT(&quot;MSM_Toon&quot;); break; &#x2F;&#x2F;**** Toon Shading Model
        default:                    ShadingModelName &#x3D; TEXT(&quot;Unknown&quot;); break;
    &#125;
    return ShadingModelName;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在MaterialShared.h中的IsSubsurfaceShadingModel中添加</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Public\MaterialShared.h

inline bool IsSubsurfaceShadingModel(FMaterialShadingModelField ShadingModel)
&#123;
    return ShadingModel.HasShadingModel(MSM_Subsurface) ||
        ShadingModel.HasShadingModel(MSM_PreintegratedSkin) ||
        ShadingModel.HasShadingModel(MSM_SubsurfaceProfile) ||
        ShadingModel.HasShadingModel(MSM_TwoSidedFoliage) ||
        ShadingModel.HasShadingModel(MSM_Cloth) ||
        ShadingModel.HasShadingModel(MSM_Eye) ||
        ShadingModel.HasShadingModel(MSM_Toon);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ShaderMaterialDerivedHelpers.cpp中添加Mat.MATERIAL_SHADINGMODEL_TOON</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\RenderCore\Private\ShaderMaterialDerivedHelpers.cpp

&#x2F;&#x2F; Only some shader models actually need custom data.
Dst.WRITES_CUSTOMDATA_TO_GBUFFER &#x3D; (Dst.USES_GBUFFER &amp;&amp; (Mat.MATERIAL_SHADINGMODEL_SUBSURFACE || Mat.MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN || Mat.MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE || Mat.MATERIAL_SHADINGMODEL_CLEAR_COAT || Mat.MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE || Mat.MATERIAL_SHADINGMODEL_HAIR || Mat.MATERIAL_SHADINGMODEL_CLOTH || Mat.MATERIAL_SHADINGMODEL_EYE || Mat.MATERIAL_SHADINGMODEL_TOON));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="根据情况开启材质接口可选"><a class="markdownIt-Anchor" href="#根据情况开启材质接口可选"></a> 根据情况开启材质接口（可选）</h5>
<p>不同的ShadingModel开发的接口不尽相同，比如，可能需要材质编辑器的UI发生变化（比如材质的节点上多出几个Pin或禁用几个Pin）。</p>
<p>Material.cpp中的bool UMaterial::IsPropertyActive(EMaterialProperty InProperty)函数用于那些接口是否Active。真正的实现逻辑在Material.cpp中的IsPropertyActive_Internal函数。</p>
<p>为Toon Shading Model开放CustomData0和CustomData1两个接口，CustomData0和CustomData1均为float类型且范围在0-1之间。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\Materials\Material.cpp

static bool IsPropertyActive_Internal(EMaterialProperty InProperty,
    EMaterialDomain Domain,
    EBlendMode BlendMode,
    FMaterialShadingModelField ShadingModels,
    ETranslucencyLightingMode TranslucencyLightingMode,
    bool bIsTessellationEnabled,
    bool bBlendableOutputAlpha,
    bool bUsesDistortion,
    bool bUsesShadingModelFromMaterialExpression,
    bool bIsTranslucencyWritingVelocity,
    bool bIsThinSurface,
    bool bIsSupported)
&#123;
    (...)
    if (bSubstrateEnabled)
    &#123;
        (...)
    &#125;
    else
    &#123;
        switch (InProperty)
        &#123;
            (...)
        case MP_CustomData0:
            Active &#x3D; ShadingModels.HasAnyShadingModel(&#123; MSM_ClearCoat, MSM_Hair, MSM_Cloth, MSM_Eye, 
                                                        MSM_SubsurfaceProfile, MSM_Toon &#125;);
            break;
        case MP_CustomData1:
            Active &#x3D; ShadingModels.HasAnyShadingModel(&#123; MSM_ClearCoat, MSM_Eye, MSM_Toon &#125;);
            break;
            (...)
        &#125;
    &#125;
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改这两个接口的名称</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">&#x2F;&#x2F; Engine\Source\Runtime\Engine\Private\Materials\MaterialAttributeDefinitionMap.cpp

FText FMaterialAttributeDefinitionMap::GetAttributeOverrideForMaterial(const FGuid&amp; AttributeID, UMaterial* Material)
&#123;
    (...)
    case MP_CustomData0:
        CustomPinNames.Add(&#123; MSM_ClearCoat, LOCTEXT(&quot;ClearCoat&quot;, &quot;Clear Coat&quot;).ToString() &#125;);
        CustomPinNames.Add(&#123; MSM_Hair, LOCTEXT(&quot;Backlit&quot;, &quot;Backlit&quot;).ToString() &#125;);
        CustomPinNames.Add(&#123; MSM_Cloth, LOCTEXT(&quot;Cloth&quot;, &quot;Cloth&quot;).ToString() &#125;);
        CustomPinNames.Add(&#123; MSM_Eye, LOCTEXT(&quot;IrisMask&quot;, &quot;Iris Mask&quot;).ToString() &#125;);
        CustomPinNames.Add(&#123; MSM_SubsurfaceProfile, LOCTEXT(&quot;Curvature&quot;, &quot;Curvature&quot;).ToString() &#125;);
        &#x2F;******************** Toon Shading Model ****************&#x2F;
        CustomPinNames.Add(&#123; MSM_Toon, LOCTEXT(&quot;Specular Range&quot;, &quot;Specular Range&quot;).ToString() &#125;);
        &#x2F;********************************************************&#x2F;
        return FText::FromString(GetPinNameFromShadingModelField(Material-&gt;GetShadingModels(), CustomPinNames, LOCTEXT(&quot;CustomData0&quot;, &quot;Custom Data 0&quot;).ToString()));
    case MP_CustomData1:
        CustomPinNames.Add(&#123; MSM_ClearCoat, LOCTEXT(&quot;ClearCoatRoughness&quot;, &quot;Clear Coat Roughness&quot;).ToString() &#125;);
        CustomPinNames.Add(&#123; MSM_Eye, LOCTEXT(&quot;IrisDistance&quot;, &quot;Iris Distance&quot;).ToString() &#125;);
        &#x2F;******************** Toon Shading Model ****************&#x2F;
        CustomPinNames.Add(&#123; MSM_Toon, LOCTEXT(&quot;Offset&quot;, &quot;Offset&quot;).ToString() &#125;);
        &#x2F;********************************************************&#x2F;
        return FText::FromString(GetPinNameFromShadingModelField(Material-&gt;GetShadingModels(), CustomPinNames, LOCTEXT(&quot;CustomData1&quot;, &quot;Custom Data 1&quot;).ToString()));
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/CustomPin.png" alt="CustomPin" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/CustomPin.png" class="lozad post-image"></p>
<h4 id="shader部分"><a class="markdownIt-Anchor" href="#shader部分"></a> Shader部分</h4>
<h5 id="在shader中定义关键字"><a class="markdownIt-Anchor" href="#在shader中定义关键字"></a> 在Shader中定义关键字</h5>
<p>在ShadingCommon中定义宏</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ShadingCommon.ush

&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
&#x2F;&#x2F; Shading models

&#x2F;&#x2F; SHADINGMODELID_* occupy the 4 low bits of an 8bit channel and SKIP_* occupy the 4 high bits
#define SHADINGMODELID_UNLIT                0
#define SHADINGMODELID_DEFAULT_LIT          1
#define SHADINGMODELID_SUBSURFACE           2
#define SHADINGMODELID_PREINTEGRATED_SKIN   3
#define SHADINGMODELID_CLEAR_COAT           4
#define SHADINGMODELID_SUBSURFACE_PROFILE   5
#define SHADINGMODELID_TWOSIDED_FOLIAGE     6
#define SHADINGMODELID_HAIR                 7
#define SHADINGMODELID_CLOTH                8
#define SHADINGMODELID_EYE                  9
#define SHADINGMODELID_SINGLELAYERWATER     10
#define SHADINGMODELID_THIN_TRANSLUCENT     11
#define SHADINGMODELID_SUBSTRATE            12      &#x2F;&#x2F; Temporary while we convert everything to Substrate
&#x2F;****************** Toon Shading Model **************&#x2F;
#define SHADINGMODELID_TOON                 13
&#x2F;****************************************************&#x2F;
&#x2F;&#x2F; don&#39;t forget +1 to SHADINGMODELID_NUM
#define SHADINGMODELID_NUM                  14
#define SHADINGMODELID_MASK                 0xF     &#x2F;&#x2F; 4 bits reserved for ShadingModelID<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在GetShadingModelColor函数中添加可视化调试颜色，PS4不支持switch-case语句，因此使用if-else</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ShadingCommon.ush

&#x2F;&#x2F; for debugging and to visualize
float3 GetShadingModelColor(uint ShadingModelID)
&#123;
    &#x2F;&#x2F; TODO: PS4 doesn&#39;t optimize out correctly the switch(), so it thinks it needs all the Samplers even if they get compiled out
    &#x2F;&#x2F; This will get fixed after launch per Sony...
#if PS4_PROFILE
    if (ShadingModelID &#x3D;&#x3D; SHADINGMODELID_UNLIT) return float3(0.1f, 0.1f, 0.2f); &#x2F;&#x2F; Dark Blue
    else if (ShadingModelID &#x3D;&#x3D; SHADINGMODELID_DEFAULT_LIT) return float3(0.1f, 1.0f, 0.1f); &#x2F;&#x2F; Green    
    (...)
    else if (ShadingModelID &#x3D;&#x3D; SHADINGMODELID_TOON) return float3(0.7f, 0.2f, 0.2f); &#x2F;&#x2F; Debugging Color for ToonShadingModel
    else return float3(1.0f, 1.0f, 1.0f); &#x2F;&#x2F; White
#else
    switch(ShadingModelID)
    &#123;
        case SHADINGMODELID_UNLIT: return float3(0.1f, 0.1f, 0.2f); &#x2F;&#x2F; Dark Blue
        case SHADINGMODELID_DEFAULT_LIT: return float3(0.1f, 1.0f, 0.1f); &#x2F;&#x2F; Green
        (...)
        case SHADINGMODELID_TOON: return float3(0.7f, 0.2f, 0.2f); &#x2F;&#x2F; Debugging Color for ToonShadingModel
        default: return float3(1.0f, 1.0f, 1.0f); &#x2F;&#x2F; White
    &#125;
#endif
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在Definitions.usf中定义宏</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\Definitions.usf

(...)
&#x2F;************* Toon Shading Model **********&#x2F;
#ifndef MATERIAL_SHADINGMODEL_TOON
#define MATERIAL_SHADINGMODEL_TOON          0
#endif
&#x2F;************* Toon Shading Model **********&#x2F;
(...)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="开启customdata写入可选"><a class="markdownIt-Anchor" href="#开启customdata写入可选"></a> 开启CustomData写入（可选）</h5>
<p>为使CustomData数据写入G-Buffer，需要进行以下修改：</p>
<ul>
<li>WRITES_CUSTOMDATA_TO_GBUFFER宏定义添加一个判断，即当ShadingModel为ToonShadingModel时也需要开启写入</li>
</ul>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\BasePassCommon.ush

#define WRITES_CUSTOMDATA_TO_GBUFFER(USES_GBUFFER &amp;&amp; (MATERIAL_SHADINGMODEL_SUBSURFACE || MATERIAL_SHADINGMODEL_PREINTEGRATED_SKIN || MATERIAL_SHADINGMODEL_SUBSURFACE_PROFILE || MATERIAL_SHADINGMODEL_CLEAR_COAT || MATERIAL_SHADINGMODEL_TWOSIDED_FOLIAGE || MATERIAL_SHADINGMODEL_HAIR || MATERIAL_SHADINGMODEL_CLOTH || MATERIAL_SHADINGMODEL_EYE || MATERIAL_SHADINGMODEL_TOON))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>DeferredShadingCommon.ush中的HasCustomGBufferData函数</li>
</ul>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\DeferredShadingCommon.ush

bool HasCustomGBufferData(int ShadingModelID)
&#123;
    return ShadingModelID &#x3D;&#x3D; SHADINGMODELID_SUBSURFACE
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_PREINTEGRATED_SKIN
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_CLEAR_COAT
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_SUBSURFACE_PROFILE
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_TWOSIDED_FOLIAGE
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_HAIR
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_CLOTH
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_EYE
        || ShadingModelID &#x3D;&#x3D; SHADINGMODELID_TOON; &#x2F;&#x2F; ToonShadingModel
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ClusteredDeferredShadingPixelShader.usf中的SetGBufferForShadingModel函数</li>
</ul>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ClusteredDeferredShadingPixelShader.usf

void SetGBufferForShadingModel(
    in out FGBufferData GBuffer, 
    in out FMaterialPixelParameters MaterialParameters,
    const float Opacity,
    const half3 BaseColor,
    const half  Metallic,
    const half  Specular,
    const float Roughness,
    const float Anisotropy,
    const float3 SubsurfaceColor,
    const float SubsurfaceProfile,
    const float Dither,
    const uint ShadingModel)
&#123;
    (...)
#if MATERIAL_SHADINGMODEL_TOON
    else if(ShadingModel &#x3D;&#x3D; SHADINGMODELID_TOON)
    &#123;
        GBuffer.CustomData.x &#x3D; saturate( GetMaterialCustomData0(MaterialParameters) ); &#x2F;&#x2F; SpecularRange
        GBuffer.CustomData.y &#x3D; saturate( GetMaterialCustomData1(MaterialParameters) ); &#x2F;&#x2F; Offset
    &#125;
#endif
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="获取光源数据"><a class="markdownIt-Anchor" href="#获取光源数据"></a> 获取光源数据</h5>
<p>在ClusteredDeferredShadingPixelShader.usf中的ClusteredShadingPixelShader函数中添加ToonShadingModel</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ClusteredDeferredShadingPixelShader.usf

void ClusteredShadingPixelShader(
    in noperspective float4 UVAndScreenPos : TEXCOORD0,
    in float4 SvPosition : SV_Position,
    out float4 OutColor : SV_Target0)
&#123;
    (...)
    &#x2F;&#x2F; Regular lights
#if USE_PASS_PER_SHADING_MODEL

    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_DEFAULT_LIT,         PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_SUBSURFACE,          PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_PREINTEGRATED_SKIN,  PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_CLEAR_COAT,          PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_SUBSURFACE_PROFILE,  PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_TWOSIDED_FOLIAGE,    PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_HAIR,                PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_CLOTH,               PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_EYE,                 PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_SINGLELAYERWATER         PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    GET_LIGHT_GRID_LOCAL_LIGHTING_SINGLE_SM(SHADINGMODELID_TOON,                PixelShadingModelID, CompositedLighting, ScreenUV, CulledLightGridData, Dither, FirstNonSimpleLightIndex);
    &#x2F;&#x2F; SHADINGMODELID_THIN_TRANSLUCENT - skipping because it can not be opaque
#else &#x2F;&#x2F; !USE_PASS_PER_SHADING_MODEL
    CompositedLighting +&#x3D; GetLightGridLocalLighting(GetScreenSpaceData(ScreenUV), CulledLightGridData, TranslatedWorldPosition, CameraVector, ScreenUV, SceneDepth, 0, Dither, FirstNonSimpleLightIndex);
#endif &#x2F;&#x2F; USE_PASS_PER_SHADING_MODEL
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="着色计算"><a class="markdownIt-Anchor" href="#着色计算"></a> 着色计算</h5>
<p>在ShadingModels.ush的IntegrateBxDF函数中，添加ToonShadingModel的分支，并实现其对应的着色计算ToonBxDF</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\ShadingModels.ush

&#x2F;******************* Toon Shading Model ***************&#x2F;
float3 ToonStep(float Range, float Input)
&#123;
    return smoothstep(0.5 - Range, 0.5 + Range, Input);
&#125;

FDirectLighting ToonBxDF(FGBufferData GBuffer, half3 N, half3 V, half3 L, float Falloff, float NoL, FAreaLight AreaLight, FShadowTerms Shadow)
&#123;
#if GBUFFER_HAS_TANGENT
    half3 X &#x3D; GBuffer.WorldTangent;
    half3 Y &#x3D; normalize(cross(N, X));
#else
    half3 X &#x3D; 0;
    half3 Y &#x3D; 0;
#endif

    BxDFContext Context;
    Init(Context, N, X, Y, V, L);
    SphereMaxNoH(Context, AreaLight.SphereSinAlpha, true);
    Context.NoV &#x3D; saturate(abs(Context.NoV) + 1e-5);

    float SpecularOffset &#x3D; 0.5;
    float SpecularRange &#x3D; GBuffer.CustomData.x;

    float3 ShadowColor &#x3D; 0;

    ShadowColor &#x3D; GBuffer.DiffuseColor * ShadowColor;
    float offset &#x3D; GBuffer.CustomData.y;
    float SoftScatterStrength &#x3D; 0;

    offset &#x3D; offset * 2 - 1;
    half3 H &#x3D; normalize(V + L);
    float NoH &#x3D; saturate(dot(N, H));
    NoL &#x3D; (dot(N, L) + 1) &#x2F; 2; &#x2F;&#x2F; overwrite NoL to get more range out of it
    half NoLOffset &#x3D; saturate(NoL + offset);

    FDirectLighting Lighting;
    Lighting.Diffuse &#x3D; AreaLight.FalloffColor * (smoothstep(0, 1, NoLOffset) * Falloff) * Diffuse_Lambert(GBuffer.DiffuseColor) * 2.2;
    float InScatter &#x3D; pow(saturate(dot(L, -V)), 12) * lerp(3, .1f, 1);
    float NormalContribution &#x3D; saturate(dot(N, H));
    float BackScatter &#x3D; GBuffer.GBufferAO * NormalContribution &#x2F; (PI * 2);
    Lighting.Specular &#x3D; ToonStep(SpecularRange, (saturate(D_GGX(SpecularOffset, NoH)))) * (AreaLight.FalloffColor * GBuffer.SpecularColor * Falloff * 8);
    float3 TransmissionSoft &#x3D; AreaLight.FalloffColor * (Falloff * lerp(BackScatter, 1, InScatter)) * ShadowColor * SoftScatterStrength;
    float3 ShadowLightener &#x3D; 0;
    ShadowLightener &#x3D; (saturate(smoothstep(0, 1, saturate(1 - NoLOffset))) * ShadowColor * 0.1);

    Lighting.Transmission &#x3D; (ShadowLightener + TransmissionSoft) * Falloff;
    return Lighting;
&#125;
&#x2F;******************************************************&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="透明模式支持体积光叠加可选"><a class="markdownIt-Anchor" href="#透明模式支持体积光叠加可选"></a> 透明模式支持体积光叠加（可选）</h5>
<p>在BasePassPixelShader.usf中FPixelShaderInOut_MainPS函数中修改预处理条件：</p>
<pre class="line-numbers language-hlsl" data-language="hlsl"><code class="language-hlsl">&#x2F;&#x2F; Engine\Shaders\Private\BasePassPixelShader.usf

void FPixelShaderInOut_MainPS(
    FVertexFactoryInterpolantsVSToPS Interpolants,
    FBasePassInterpolantsVSToPS BasePassInterpolants,
    in FPixelShaderIn In,
    inout FPixelShaderOut Out)
&#123;
    (...)

    &#x2F;&#x2F; Volume lighting for lit translucency
    &#x2F;&#x2F; Add ToonShadingModel
#if (MATERIAL_SHADINGMODEL_DEFAULT_LIT || MATERIAL_SHADINGMODEL_SUBSURFACE || MATERIAL_SHADINGMODEL_TOON) &amp;&amp; (MATERIALBLENDING_TRANSLUCENT || MATERIALBLENDING_ADDITIVE) &amp;&amp; !FORWARD_SHADING
    if (GBuffer.ShadingModelID &#x3D;&#x3D; SHADINGMODELID_DEFAULT_LIT || GBuffer.ShadingModelID &#x3D;&#x3D; SHADINGMODELID_SUBSURFACE || GBuffer.ShadingModelID &#x3D;&#x3D; SHADINGMODELID_TOON)
    &#123;
        Color +&#x3D; GetTranslucencyVolumeLighting(MaterialParameters, PixelMaterialInputs, BasePassInterpolants, GBuffer, IndirectIrradiance);
    &#125;
#endif
    
    (...)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="效果"><a class="markdownIt-Anchor" href="#效果"></a> 效果</h4>
<h5 id="debug模式下"><a class="markdownIt-Anchor" href="#debug模式下"></a> Debug模式下</h5>
<p><img src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/DebugMode.png" alt="DebugMode" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/DebugMode.png" class="lozad post-image"></p>
<h5 id="新建材质"><a class="markdownIt-Anchor" href="#新建材质"></a> 新建材质</h5>
<p><img src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/CreateMaterial.png" alt="CreateMaterial" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/CreateMaterial.png" class="lozad post-image"></p>
<p><img src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/Final.png" alt="Final" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/Final.png" class="lozad post-image"></p>
<h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2>
<p><a target="_blank" rel="noopener" href="https://dev.epicgames.com/documentation/en-us/unreal-engine/shading-models-in-unreal-engine">Unreal Engine Documentation: Shading Models in Unreal Engine</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qjh5606/article/details/117998757">虚幻引擎之自定义着色模型（ShadingModel）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33967521/article/details/106949986">在UE4中创建新的Shading Model</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/212785666">[UE4] Custom Shading Model</a></p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            SUIKASAN
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://suikasan111.github.io/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/">
            https://suikasan111.github.io/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2024/06/21/UE5/UE5-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89GlobalShader/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">Prev</div>
          
            <div class="nav-title">UE5-添加自定义GlobalShader </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2024/06/17/UE5/UE5-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%90%E8%B4%A8%E8%8A%82%E7%82%B9/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">UE5-添加自定义材质节点 </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ue5-%E5%86%85%E7%BD%AEshadingmodels"><span class="toc-text"> UE5 内置ShadingModels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89shading-model"><span class="toc-text"> 添加自定义Shading Model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0shading-model%E7%9A%84%E6%80%BB%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-text"> 添加Shading Model的总体步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0toonshadingmodel"><span class="toc-text"> 添加ToonShadingModel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#c%E9%83%A8%E5%88%86"><span class="toc-text"> C++部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9Eshading-model%E6%9E%9A%E4%B8%BE"><span class="toc-text"> 新增Shading Model枚举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 增加对应的关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%83%85%E5%86%B5%E5%BC%80%E5%90%AF%E6%9D%90%E8%B4%A8%E6%8E%A5%E5%8F%A3%E5%8F%AF%E9%80%89"><span class="toc-text"> 根据情况开启材质接口（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shader%E9%83%A8%E5%88%86"><span class="toc-text"> Shader部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8shader%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 在Shader中定义关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AFcustomdata%E5%86%99%E5%85%A5%E5%8F%AF%E9%80%89"><span class="toc-text"> 开启CustomData写入（可选）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%89%E6%BA%90%E6%95%B0%E6%8D%AE"><span class="toc-text"> 获取光源数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E8%AE%A1%E7%AE%97"><span class="toc-text"> 着色计算</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E6%A8%A1%E5%BC%8F%E6%94%AF%E6%8C%81%E4%BD%93%E7%A7%AF%E5%85%89%E5%8F%A0%E5%8A%A0%E5%8F%AF%E9%80%89"><span class="toc-text"> 透明模式支持体积光叠加（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text"> 效果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debug%E6%A8%A1%E5%BC%8F%E4%B8%8B"><span class="toc-text"> Debug模式下</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E6%9D%90%E8%B4%A8"><span class="toc-text"> 新建材质</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ue5-%E5%86%85%E7%BD%AEshadingmodels"><span class="toc-text"> UE5 内置ShadingModels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89shading-model"><span class="toc-text"> 添加自定义Shading Model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0shading-model%E7%9A%84%E6%80%BB%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-text"> 添加Shading Model的总体步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0toonshadingmodel"><span class="toc-text"> 添加ToonShadingModel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#c%E9%83%A8%E5%88%86"><span class="toc-text"> C++部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9Eshading-model%E6%9E%9A%E4%B8%BE"><span class="toc-text"> 新增Shading Model枚举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 增加对应的关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%83%85%E5%86%B5%E5%BC%80%E5%90%AF%E6%9D%90%E8%B4%A8%E6%8E%A5%E5%8F%A3%E5%8F%AF%E9%80%89"><span class="toc-text"> 根据情况开启材质接口（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shader%E9%83%A8%E5%88%86"><span class="toc-text"> Shader部分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8shader%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text"> 在Shader中定义关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AFcustomdata%E5%86%99%E5%85%A5%E5%8F%AF%E9%80%89"><span class="toc-text"> 开启CustomData写入（可选）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%89%E6%BA%90%E6%95%B0%E6%8D%AE"><span class="toc-text"> 获取光源数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E8%AE%A1%E7%AE%97"><span class="toc-text"> 着色计算</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E6%A8%A1%E5%BC%8F%E6%94%AF%E6%8C%81%E4%BD%93%E7%A7%AF%E5%85%89%E5%8F%A0%E5%8A%A0%E5%8F%AF%E9%80%89"><span class="toc-text"> 透明模式支持体积光叠加（可选）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text"> 效果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debug%E6%A8%A1%E5%BC%8F%E4%B8%8B"><span class="toc-text"> Debug模式下</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E6%9D%90%E8%B4%A8"><span class="toc-text"> 新建材质</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-07-16</div>
        <a href="/2024/07/16/UE5/UE5-%E6%B8%B2%E6%9F%93%E5%B9%B6%E8%A1%8C%E5%8C%96/"><div class="recent-posts-item-content">UE5-渲染并行化</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-06-24</div>
        <a href="/2024/06/24/UE5/UE5-MeshDrawingPipeline/"><div class="recent-posts-item-content">UE5-Mesh Drawing Pipeline</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-06-21</div>
        <a href="/2024/06/21/UE5/UE5-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89GlobalShader/"><div class="recent-posts-item-content">UE5-添加自定义GlobalShader</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-06-18</div>
        <a href="/2024/06/18/UE5/UE5-%E6%B7%BB%E5%8A%A0ShadingModel/"><div class="recent-posts-item-content">UE5-添加ShadingModel</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2022
          
          
                - 
                2024
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          SUIKASAN
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
      <div class="footer-dsc">
        
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
    <script src="/js/prism/prism.js" async></script>
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
      
 
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
    
      <script> 
        loadScript('/js/lib/busuanzi.min.js') 
      </script>
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
      <script>
        setTimeout(() => {localSearch("search.json")}, 0)
      </script>
    
  </body>
</html>
